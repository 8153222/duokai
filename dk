#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ç½‘ç»œéªŒè¯ç³»ç»Ÿ - æ•´åˆç‰ˆæœ¬
åŒ…å«éªŒè¯å®¢æˆ·ç«¯å’Œæ¼”ç¤ºåŠŸèƒ½çš„å®Œæ•´è§£å†³æ–¹æ¡ˆ
"""

import requests
import hashlib
import platform
import uuid
import time
import json
import threading
import socket
import re
from typing import Dict, Any
import logging

class VerificationClient:
    """ç½‘ç»œéªŒè¯å®¢æˆ·ç«¯"""

    def __init__(self, api_url: str, app_key: str, app_secret: str = ""):
        """
        åˆå§‹åŒ–éªŒè¯å®¢æˆ·ç«¯

        Args:
            api_url: APIæœåŠ¡å™¨åœ°å€
            app_key: é¡¹ç›®AppKey
            app_secret: é¡¹ç›®AppSecretï¼ˆç”¨äºç­¾åéªŒè¯ï¼Œå¢å¼ºå®‰å…¨æ€§ï¼‰
        """
        self.api_url = api_url.rstrip('/')
        self.app_key = app_key
        self.app_secret = app_secret
        self.session = requests.Session()
        self.session.timeout = 10
        self.heartbeat_timer = None
        self.is_verified = False
        self.license_key = None
        self.session_token = None

        # è®¾ç½®æ—¥å¿—
        logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
        self.logger = logging.getLogger(__name__)

        # å¦‚æœæä¾›äº†AppSecretï¼Œå¯ç”¨ç­¾åéªŒè¯
        if self.app_secret:
            self.logger.info("å·²å¯ç”¨AppSecretç­¾åéªŒè¯ï¼Œå¢å¼ºå®‰å…¨æ€§")
        else:
            self.logger.warning("æœªæä¾›AppSecretï¼Œå»ºè®®å¯ç”¨ç­¾åéªŒè¯ä»¥å¢å¼ºå®‰å…¨æ€§")
        
    def _get_real_ip(self) -> str:
        """è·å–çœŸå®çš„å¤–ç½‘IPåœ°å€"""
        try:
            # æ–¹æ³•1: é€šè¿‡å¤šä¸ªIPæŸ¥è¯¢æœåŠ¡è·å–å¤–ç½‘IP
            ip_services = [
                'https://api.ipify.org',
                'https://icanhazip.com',
                'https://ident.me',
                'https://ipecho.net/plain',
                'https://myexternalip.com/raw',
                'https://checkip.amazonaws.com',
                'https://ipv4.icanhazip.com',
                'https://api.ip.sb/ip',
                'https://httpbin.org/ip',
                'http://ip-api.com/line/?fields=query'
            ]

            self.logger.debug("å¼€å§‹è·å–å¤–ç½‘IPåœ°å€...")

            for i, service in enumerate(ip_services):
                try:
                    self.logger.debug(f"å°è¯•æœåŠ¡ {i+1}/{len(ip_services)}: {service}")

                    # è®¾ç½®è¾ƒçŸ­çš„è¶…æ—¶æ—¶é—´ï¼Œå¿«é€Ÿå¤±è´¥ï¼Œç¦ç”¨ä»£ç†
                    response = requests.get(
                        service,
                        timeout=3,
                        proxies={'http': None, 'https': None},  # ç¦ç”¨ä»£ç†
                        headers={'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'}
                    )
                    if response.status_code == 200:
                        ip_text = response.text.strip()

                        # å¤„ç†JSONæ ¼å¼çš„å“åº”ï¼ˆå¦‚httpbin.orgï¼‰
                        if service == 'https://httpbin.org/ip':
                            import json
                            ip_data = json.loads(ip_text)
                            ip = ip_data.get('origin', '').split(',')[0].strip()
                        else:
                            ip = ip_text

                        # éªŒè¯IPæ ¼å¼
                        if re.match(r'^(\d{1,3}\.){3}\d{1,3}$', ip):
                            # éªŒè¯IPä¸æ˜¯å†…ç½‘åœ°å€
                            ip_parts = ip.split('.')
                            first_octet = int(ip_parts[0])
                            second_octet = int(ip_parts[1])

                            # æ’é™¤å†…ç½‘IPæ®µ
                            if not (
                                first_octet == 10 or  # 10.0.0.0/8
                                (first_octet == 172 and 16 <= second_octet <= 31) or  # 172.16.0.0/12
                                (first_octet == 192 and second_octet == 168) or  # 192.168.0.0/16
                                first_octet == 127  # 127.0.0.0/8 (localhost)
                            ):
                                self.logger.info(f"æˆåŠŸè·å–å¤–ç½‘IP: {ip} ")
                                return ip
                            else:
                                self.logger.debug(f"è·³è¿‡å†…ç½‘IP: {ip}")

                except Exception as e:
                    self.logger.debug(f"æœåŠ¡ {service} å¤±è´¥: {e}")
                    continue

           

            # æ–¹æ³•4: å°è¯•è·å–é»˜è®¤ç½‘å…³ç›¸å…³çš„IP
            self.logger.debug("å°è¯•è·å–ç½‘ç»œé…ç½®ç›¸å…³IP...")
            try:
                # åœ¨Windowsä¸Šå°è¯•ä½¿ç”¨ipconfigå‘½ä»¤
                import subprocess
                import platform

                if platform.system() == "Windows":
                    result = subprocess.run(['ipconfig'], capture_output=True, text=True, timeout=5)
                    if result.returncode == 0:
                        lines = result.stdout.split('\n')
                        for line in lines:
                            if 'IPv4' in line and ':' in line:
                                ip = line.split(':')[1].strip()
                                if re.match(r'^(\d{1,3}\.){3}\d{1,3}$', ip) and not ip.startswith('127.') and not ip.startswith('169.254.'):
                                    self.logger.info(f"é€šè¿‡ipconfigè·å–åˆ°IP: {ip}")
                                    return ip
                else:
                    # Linux/Macç³»ç»Ÿ
                    result = subprocess.run(['hostname', '-I'], capture_output=True, text=True, timeout=5)
                    if result.returncode == 0:
                        ips = result.stdout.strip().split()
                        for ip in ips:
                            if re.match(r'^(\d{1,3}\.){3}\d{1,3}$', ip) and not ip.startswith('127.') and not ip.startswith('169.254.'):
                                self.logger.info(f"é€šè¿‡hostname -Iè·å–åˆ°IP: {ip}")
                                return ip
            except Exception as e:
                self.logger.debug(f"é€šè¿‡ç³»ç»Ÿå‘½ä»¤è·å–IPå¤±è´¥: {e}")

           

        except Exception as e:
            self.logger.error(f"è·å–IPåœ°å€æ—¶å‘ç”Ÿä¸¥é‡é”™è¯¯: {e}")
            return "unknown"

    def _get_mac_address(self) -> str:
        """è·å–MACåœ°å€"""
        try:
            mac = uuid.getnode()
            mac_str = ':'.join(['{:02x}'.format((mac >> elements) & 0xff)
                               for elements in range(0, 2*6, 2)][::-1])
            return mac_str.upper()
        except Exception as e:
            self.logger.warning(f"è·å–MACåœ°å€å¤±è´¥: {e}")
            return "unknown"


    
    def _generate_sign(self, license_key: str) -> str:
        """ç”Ÿæˆç­¾å"""
        if not self.app_secret:
            return ""
        sign_string = f"{self.app_key}{license_key}{self.app_secret}"
        return hashlib.md5(sign_string.encode()).hexdigest()
    
    def _send_request(self, data: Dict[str, Any]) -> Dict[str, Any]:
        """å‘é€HTTPè¯·æ±‚"""
        try:
            url = f"{self.api_url}/api/verify.php"

            # æ·»åŠ é€šç”¨å‚æ•°
            data.update({
                'app_key': self.app_key
            })

            # è‡ªåŠ¨æ·»åŠ å®¢æˆ·ç«¯IPå’ŒMACåœ°å€ï¼ˆå¦‚æœæ²¡æœ‰æ‰‹åŠ¨æŒ‡å®šï¼‰
            if 'client_ip' not in data or not data['client_ip']:
                data['client_ip'] = self._get_real_ip()

            if 'client_mac' not in data or not data['client_mac']:
                data['client_mac'] = self._get_mac_address()

            # æ·»åŠ ç­¾åï¼ˆå¦‚æœæœ‰app_secretï¼‰
            if self.app_secret and 'license_key' in data:
                data['sign'] = self._generate_sign(data['license_key'])

            self.logger.debug(f"å‘é€è¯·æ±‚: {url}")
            self.logger.debug(f"è¯·æ±‚æ•°æ®: {dict(data, **{'client_ip': data.get('client_ip', 'unknown')[:10] + '...' if len(data.get('client_ip', '')) > 10 else data.get('client_ip', 'unknown')})}")

            response = self.session.post(url, data=data)
            response.raise_for_status()

            result = response.json()
            self.logger.debug(f"æ”¶åˆ°å“åº”: {result}")

            return result

        except requests.exceptions.RequestException as e:
            self.logger.error(f"ç½‘ç»œè¯·æ±‚å¤±è´¥: {e}")
            return {'success': False, 'message': f'ç½‘ç»œè¯·æ±‚å¤±è´¥: {str(e)}'}
        except json.JSONDecodeError as e:
            self.logger.error(f"å“åº”è§£æå¤±è´¥: {e}")
            return {'success': False, 'message': f'å“åº”è§£æå¤±è´¥: {str(e)}'}
        except Exception as e:
            self.logger.error(f"è¯·æ±‚å¤„ç†å¤±è´¥: {e}")
            return {'success': False, 'message': f'è¯·æ±‚å¤„ç†å¤±è´¥: {str(e)}'}
    
    def verify(self, license_key: str) -> Dict[str, Any]:
        """
        éªŒè¯å¡å¯†
        
        Args:
            license_key: å¡å¯†
            
        Returns:
            éªŒè¯ç»“æœå­—å…¸
        """
        data = {
            'action': 'verify',
            'license_key': license_key
        }
        
        result = self._send_request(data)
        
        if result.get('success'):
            self.is_verified = True
            self.license_key = license_key
            self.session_token = result.get('data', {}).get('session_token')
            self.logger.info(f"å¡å¯†éªŒè¯æˆåŠŸ: {license_key}")
            if self.session_token:
                self.logger.info(f"ä¼šè¯ä»¤ç‰Œå·²è·å–ï¼Œå¯ç”¨å®‰å…¨é€šä¿¡")
        else:
            self.is_verified = False
            self.license_key = None
            self.session_token = None
            self.logger.error(f"å¡å¯†éªŒè¯å¤±è´¥: {result.get('message', 'æœªçŸ¥é”™è¯¯')}")
        
        return result
    
    def heartbeat(self, license_key: str = None) -> Dict[str, Any]:
        """
        å‘é€å¿ƒè·³åŒ…

        Args:
            license_key: å¡å¯†ï¼ˆå¯é€‰ï¼Œå¦‚æœä¸æä¾›åˆ™ä½¿ç”¨å·²éªŒè¯çš„å¡å¯†ï¼‰

        Returns:
            å¿ƒè·³ç»“æœå­—å…¸
        """
        if not license_key:
            license_key = self.license_key

        if not license_key:
            return {'success': False, 'message': 'æ²¡æœ‰å¯ç”¨çš„å¡å¯†'}

        data = {
            'action': 'heartbeat',
            'license_key': license_key
        }

        # åªæœ‰åœ¨æœ‰session_tokenæ—¶æ‰æ·»åŠ 
        if self.session_token:
            data['session_token'] = self.session_token

        result = self._send_request(data)

        # æ‰“å°å¿ƒè·³å“åº”ä¿¡æ¯
        if result.get('success'):
            print(f"âœ… å¿ƒè·³æˆåŠŸ")
            if result.get('data'):
                response_data = result.get('data', {})
                if 'server_time' in response_data:
                    print(f"â° æœåŠ¡å™¨æ—¶é—´: {response_data['server_time']}")
                if 'session_valid' in response_data:
                    print(f"ğŸ” ä¼šè¯çŠ¶æ€: {'æœ‰æ•ˆ' if response_data['session_valid'] else 'æ— æ•ˆ'}")
            self.logger.debug(f"å¿ƒè·³åŒ…å‘é€æˆåŠŸ")
        else:
            print(f"âŒ å¿ƒè·³å¤±è´¥: {result.get('message', 'æœªçŸ¥é”™è¯¯')}")
            self.logger.warning(f"å¿ƒè·³åŒ…å‘é€å¤±è´¥: {result.get('message', 'æœªçŸ¥é”™è¯¯')}")

            # ä»»ä½•å¿ƒè·³å¤±è´¥éƒ½åº”è¯¥åœæ­¢å®¢æˆ·ç«¯ï¼ˆåŒ…æ‹¬ç½‘ç»œé”™è¯¯ï¼‰
            print(f"ğŸš¨ å¿ƒè·³å¤±è´¥ï¼Œå®¢æˆ·ç«¯çŠ¶æ€å·²å¤±æ•ˆ")
            self.logger.error(f"å¿ƒè·³å¤±è´¥ï¼Œåœæ­¢å®¢æˆ·ç«¯: {result.get('message')}")
            self.is_verified = False
            self.license_key = None
            self.session_token = None

        return result
    
    def get_project_info(self) -> Dict[str, Any]:
        """è·å–é¡¹ç›®ä¿¡æ¯"""
        data = {
            'action': 'info',
            'license_key': 'dummy'  # infoæ¥å£ä¸éœ€è¦çœŸå®å¡å¯†
        }
        
        return self._send_request(data)
    
    def get_announcement(self) -> Dict[str, Any]:
        """è·å–é¡¹ç›®å…¬å‘Š"""
        data = {
            'action': 'announcement',
            'license_key': 'dummy'  # announcementæ¥å£ä¸éœ€è¦çœŸå®å¡å¯†
        }
        
        return self._send_request(data)
    
    def start_heartbeat_timer(self, interval: int = 30):
        """
        å¯åŠ¨å¿ƒè·³å®šæ—¶å™¨

        Args:
            interval: å¿ƒè·³é—´éš”ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤30ç§’
        """
        if not self.is_verified or not self.license_key:
            self.logger.warning("æœªéªŒè¯æˆåŠŸï¼Œæ— æ³•å¯åŠ¨å¿ƒè·³å®šæ—¶å™¨")
            return

        def heartbeat_worker():
            while self.is_verified and self.license_key:
                try:
                    result = self.heartbeat()
                    if not result.get('success'):
                        self.logger.error(f"å¿ƒè·³å¤±è´¥ï¼Œåœæ­¢å®šæ—¶å™¨: {result.get('message')}")

                        # ä»»ä½•å¿ƒè·³å¤±è´¥éƒ½åº”è¯¥åœæ­¢å®¢æˆ·ç«¯
                        print(f"ğŸš¨ å¿ƒè·³å¤±è´¥ï¼Œå®¢æˆ·ç«¯çŠ¶æ€å·²å¤±æ•ˆï¼")
                        print(f"ğŸ’¬ å¤±è´¥åŸå› : {result.get('message')}")
                        print(f"ğŸ”š åœæ­¢å¿ƒè·³å®šæ—¶å™¨...")
                        self.logger.critical(f"å¿ƒè·³å¤±è´¥ï¼Œåœæ­¢å®¢æˆ·ç«¯: {result.get('message')}")

                        # è®¾ç½®çŠ¶æ€ä¸ºå¤±æ•ˆ
                        self.is_verified = False
                        self.license_key = None
                        self.session_token = None
                        break
                    time.sleep(interval)
                except Exception as e:
                    self.logger.error(f"å¿ƒè·³å®šæ—¶å™¨å¼‚å¸¸: {e}")
                    print(f"ğŸš¨ å¿ƒè·³å®šæ—¶å™¨å¼‚å¸¸: {e}")
                    print(f"ğŸ”š å®¢æˆ·ç«¯çŠ¶æ€å·²å¤±æ•ˆï¼Œåœæ­¢å¿ƒè·³...")
                    # å¼‚å¸¸ä¹Ÿåº”è¯¥åœæ­¢å®¢æˆ·ç«¯
                    self.is_verified = False
                    self.license_key = None
                    self.session_token = None
                    break

        self.heartbeat_timer = threading.Thread(target=heartbeat_worker, daemon=True)
        self.heartbeat_timer.start()
        self.logger.info(f"å¿ƒè·³å®šæ—¶å™¨å·²å¯åŠ¨ï¼Œé—´éš”: {interval}ç§’")
    
    def stop_heartbeat_timer(self):
        """åœæ­¢å¿ƒè·³å®šæ—¶å™¨"""
        self.is_verified = False
        if self.heartbeat_timer and self.heartbeat_timer.is_alive():
            self.logger.info("æ­£åœ¨åœæ­¢å¿ƒè·³å®šæ—¶å™¨...")
            # ç­‰å¾…çº¿ç¨‹ç»“æŸ
            self.heartbeat_timer.join(timeout=5)
    

    
    def get_client_info(self) -> Dict[str, str]:
        """
        è·å–å®¢æˆ·ç«¯ä¿¡æ¯

        Returns:
            åŒ…å«å®¢æˆ·ç«¯ä¿¡æ¯çš„å­—å…¸
        """
        return {
            'client_ip': self._get_real_ip(),
            'client_mac': self._get_mac_address(),
            'hostname': platform.node(),
            'system': platform.system(),
            'platform': platform.platform()
        }

    def is_online(self) -> bool:
        """æ£€æŸ¥æ˜¯å¦åœ¨çº¿ï¼ˆå·²éªŒè¯ä¸”å¿ƒè·³æ­£å¸¸ï¼‰"""
        return self.is_verified and self.license_key is not None


# ==================== æ¼”ç¤ºåŠŸèƒ½éƒ¨åˆ† ====================

# é…ç½®ä¿¡æ¯
API_URL = "http://192.168.1.1"
APP_KEY = "app_355dfa1d873ca578078d27f7ea618728"
APP_SECRET = "9e0c349bb311ede94399b29ec28f9142da1222b5d47b5715eee7d0199ca33c4e"
LICENSE_KEY = "433NL9BEGWVLOM3L"  # æµ‹è¯•å¡å¯†

# åˆ›å»ºå®¢æˆ·ç«¯å®ä¾‹
client = VerificationClient(API_URL, APP_KEY, APP_SECRET)

def get_project_info():
    """è·å–é¡¹ç›®ä¿¡æ¯"""
    print("=" * 50)
    print("1. è·å–é¡¹ç›®æè¿°ä¸å…¬å‘Š...")

    # è·å–é¡¹ç›®ä¿¡æ¯
    info_result = client.get_project_info()
    if info_result.get('success'):
        data = info_result.get('data', {})
        print(f"âœ… é¡¹ç›®åç§°: {data.get('project_name', 'æœªçŸ¥')}")
        print(f"âœ… é¡¹ç›®æè¿°: {data.get('project_description', 'æ— æè¿°')}")
    else:
        print(f"âŒ è·å–é¡¹ç›®ä¿¡æ¯å¤±è´¥: {info_result.get('message')}")
        return False

    # è·å–å…¬å‘Š
    announcement_result = client.get_announcement()
    if announcement_result.get('success'):
        data = announcement_result.get('data', {})
        print(f"âœ… é¡¹ç›®å…¬å‘Š: {data.get('announcement', 'æ— å…¬å‘Š')}")
    else:
        print(f"âŒ è·å–å…¬å‘Šå¤±è´¥: {announcement_result.get('message')}")

    return True

def verify_license():
    """éªŒè¯å¡å¯†"""
    print("=" * 50)
    print("2. éªŒè¯å¡å¯†ï¼ˆå•å¡ç™»å½•ï¼‰...")

    result = client.verify(LICENSE_KEY)

    if result.get('success'):
        data = result.get('data', {})
        print("âœ… å¡å¯†éªŒè¯æˆåŠŸ!")
        print(f"âœ… å¡å¯†: {LICENSE_KEY}")
        print(f"âœ… åˆ°æœŸæ—¶é—´: {data.get('expires_at', 'æœªçŸ¥')}")
        print(f"âœ… å‰©ä½™æ—¶é•¿: {data.get('duration_text', 'æœªçŸ¥')}")

        # æ˜¾ç¤ºåˆ°æœŸä¿¡æ¯
        print("=" * 50)
        print(f"â° å¡å¯†åˆ°æœŸæ—¶é—´: {data.get('expires_at', 'æœªçŸ¥')}")
        print(f"â³ å‰©ä½™æ—¶é•¿: {data.get('duration_text', 'æœªçŸ¥')}")

        return True
    else:
        print(f"âŒ å¡å¯†éªŒè¯å¤±è´¥: {result.get('message')}")
        return False

def send_heartbeat():
    """å‘é€å¿ƒè·³åŒ…"""
    print("=" * 50)
    print("3. å‘é€å¿ƒè·³åŒ…ï¼ˆä¿æŒç™»å½•çŠ¶æ€ï¼‰...")

    result = client.heartbeat()

    if result.get('success'):
        print("âœ… å¿ƒè·³åŒ…å‘é€æˆåŠŸï¼Œä¿æŒåœ¨çº¿")
        return True
    else:
        print(f"âŒ å¿ƒè·³åŒ…å‘é€å¤±è´¥: {result.get('message')}")
        return False

def start_heartbeat_timer(interval=30):
    """å¯åŠ¨è‡ªåŠ¨å¿ƒè·³å®šæ—¶å™¨ï¼ˆåå°ä¿æŒåœ¨çº¿ï¼‰"""
    print("=" * 50)
    print(f"å¯åŠ¨è‡ªåŠ¨å¿ƒè·³ï¼ˆæ¯{interval}ç§’ä¸€æ¬¡ï¼‰...")

    try:
        client.start_heartbeat_timer(interval=interval)
        print(f"âœ… è‡ªåŠ¨å¿ƒè·³å·²å¯åŠ¨ï¼Œå°†ä¿æŒå¡å¯†åœ¨çº¿çŠ¶æ€")
        return True
    except Exception as e:
        print(f"âŒ å¯åŠ¨å¿ƒè·³å®šæ—¶å™¨å¤±è´¥: {str(e)}")
        return False

def run_core_demo():
    """è¿è¡Œæ ¸å¿ƒåŠŸèƒ½æ¼”ç¤ºæµç¨‹"""
    print("=" * 50)
    print("ç½‘ç»œéªŒè¯ç³»ç»Ÿæ ¸å¿ƒåŠŸèƒ½æ¼”ç¤º")
    print("=" * 50)

    try:
        # 1. è·å–é¡¹ç›®ä¿¡æ¯
        if not get_project_info():
            print("âš ï¸ è·å–é¡¹ç›®ä¿¡æ¯å¤±è´¥ï¼Œæ¼”ç¤ºç»ˆæ­¢")
            return

        # 2. éªŒè¯å¡å¯†
        if not verify_license():
            print("âš ï¸ å¡å¯†éªŒè¯å¤±è´¥ï¼Œæ¼”ç¤ºç»ˆæ­¢")
            return

        # 3. å‘é€å¿ƒè·³åŒ…
        if not send_heartbeat():
            print("âš ï¸ å¿ƒè·³åŒ…å‘é€å¤±è´¥ï¼Œä½†ç»§ç»­æ¼”ç¤º")

        # 4. å¯åŠ¨è‡ªåŠ¨å¿ƒè·³ï¼ˆ30ç§’é—´éš”ï¼‰
        if start_heartbeat_timer(interval=30):
            print("=" * 50)
            print(f"ğŸ”‘ å¡å¯†: {LICENSE_KEY}")
            print("æ¨¡æ‹Ÿè½¯ä»¶è¿è¡Œä¸­... (æŒ‰Ctrl+Cé€€å‡º)")
            print("è‡ªåŠ¨å¿ƒè·³å°†åœ¨åå°ä¿æŒå¡å¯†åœ¨çº¿")
            print("ğŸ’¡ æç¤º: ç¨‹åºå°†ä¿æŒè¿è¡ŒçŠ¶æ€ï¼ŒæŒ‰Ctrl+Cé€€å‡º")

            while True:
                time.sleep(10)  # æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡çŠ¶æ€
                is_online = client.is_online()
                print(f"å½“å‰åœ¨çº¿çŠ¶æ€: {'âœ… åœ¨çº¿' if is_online else 'âŒ ç¦»çº¿'}")

                # å¦‚æœæ£€æµ‹åˆ°ç¦»çº¿çŠ¶æ€ï¼Œé€€å‡ºç¨‹åº
                if not is_online:
                    print("ğŸš¨ æ£€æµ‹åˆ°å®¢æˆ·ç«¯å·²ç¦»çº¿ï¼Œç¨‹åºå³å°†é€€å‡º...")
                    break
        else:
            print("âš ï¸ è‡ªåŠ¨å¿ƒè·³å¯åŠ¨å¤±è´¥ï¼Œæ¼”ç¤ºç»ˆæ­¢")

    except KeyboardInterrupt:
        print("\nğŸ›‘ ç”¨æˆ·ä¸­æ–­ç¨‹åº")
    except Exception as e:
        print(f"âŒ æ¼”ç¤ºè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {str(e)}")
    finally:
        # æ¸…ç†èµ„æº
        print("ğŸ§¹ æ­£åœ¨æ¸…ç†èµ„æº...")
        client.stop_heartbeat_timer()
        print("âœ… ç¨‹åºå·²é€€å‡º")

def main():
    """ä¸»å‡½æ•°"""
    print("=" * 50)
    print("ğŸš€ ç½‘ç»œéªŒè¯ç³»ç»Ÿ - æ•´åˆç‰ˆæœ¬")
    print("=" * 50)
    print(f"ğŸ“¡ æœåŠ¡å™¨åœ°å€: {API_URL}")
    print(f"ğŸ”‘ åº”ç”¨å¯†é’¥: {APP_KEY}")
    print(f"ğŸ« æµ‹è¯•å¡å¯†: {LICENSE_KEY}")
    print(f"ğŸ–¥ï¸  è®¾å¤‡MAC: {client._get_mac_address()}")
    print("=" * 50)

    # è¿è¡Œæ ¸å¿ƒåŠŸèƒ½æ¼”ç¤º
    run_core_demo()

if __name__ == "__main__":
    main()
